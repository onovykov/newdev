public class NameSimilarityUtil {
    public static final Boolean TO_UPPER_CASE = true;
    public static final Boolean TO_LOWER_CASE = false;
    public static final Boolean FIND_BY_NAME = true;
    public static final Boolean FIND_BY_CODE = false;
    public static final Boolean FIND_BY_ID_ERP = true;
    public static final Boolean FIND_BY_SF_ID = false;  
    public static final Boolean BY_SELECT = true;
    public static final Boolean BY_APEX = false;     
    public static final Boolean INSERT_YES = true;
    public static final Boolean INSERT_NO = false;
    
    // --- –ü–æ–≤–µ—Ä—Ç–∞—î —É–Ω—ñ–∫–∞–ª—å–Ω—ñ –ø–∞—Ä–∏ String/Account –¥–ª—è –ø–æ—á–∞—Ç–∫–æ–≤–æ–≥–æ —Ä—è–¥–∫—É –ø–æ—à—É–∫—É ---
    //     –ó–∞—Å—Ç–æ—Å–æ–≤—É—î—Ç—å—Å—è —Ç–æ–¥—ñ, –∫–æ–ª–∏ –º–∏ —à—É–∫–∞—î–º–æ –º–æ–∂–ª–∏–≤—ñ –¥—É–±–ª—ñ –¥–ª—è –Ω–æ–≤–æ—ó –Ω–∞–∑–≤–∏ —Å–µ—Ä–µ–¥ —É–∂–µ –Ω–∞—è–≤–Ω–∏—Ö –∞–∫–∞—É–Ω—Ç—ñ–≤
    //     –í –ø–∞—Ä—É –¥–æ–¥–∞—î—Ç—å—Å—è
    //     - –Ω–∞–∑–≤–∞, —è–∫–∞ —î –æ—Å–Ω–æ–≤–æ—é –ø–æ—à–∫—É (–ø–æ—à—É–∫ –∑–∞ –Ω–∞–∑–≤–æ—é - isFindByName=true)
    //     - –æ–±'—î–∫—Ç Account –≤ –ø–æ–ª–µ acc1 –∫–ª–∞—Å—É AccountPair
    //       –ü–æ–ª–µ acc2 –≤ —Ü—å–æ–º—É —Ä–∞–∑—ñ –∑–∞–≤–∂–¥–∏ –±—É–¥–µ null
    //       –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –Ω–∞–∑–≤ —Ç–∞ –æ–±—Ä–∞—Ö—É–Ω–æ–∫ match-—ñ–Ω–¥–µ–∫—Å—ñ–≤ —Ä–æ–±–∏—Ç—å—Å—è –¥–ª—è —Ä—è–¥–∫—É –Ω–∞–∑–≤–∏ —Ç–∞ –ø–æ–ª—è acc1.Name
    public static List<AccountPair> getAccPairList(String sourceString, List<Account> accList) {
        List<AccountPair> accPairList = new List<AccountPair>();
        if (accList == null || accList.isEmpty()) {
            System.debug('‚ùå ERROR: List of arguments is invalid!');
            return accPairList;
        }

        for(Account recAcc : accList) {
            accPairList.add(new AccountPair(sourceString, recAcc, null));
        }
        return accPairList;
    }

    // --- –ü–æ–≤–µ—Ä—Ç–∞—î —É–Ω—ñ–∫–∞–ª—å–Ω—ñ –ø–∞—Ä–∏ –∞–∫–∞—É–Ω—Ç—ñ–≤ –∑ –¥–æ–≤—ñ–ª—å–Ω–æ–≥–æ –ª–∏—Å—Ç–∞ ---
    public static List<AccountPair> getAccPairList(List<Account> accList) {
        List<AccountPair> accPairList = new List<AccountPair>();
        if (accList == null || accList.isEmpty()) {
            System.debug('‚ùå ERROR: List of arguments is invalid!');
            return accPairList;
        }

        for (Integer i = 0; i < accList.size(); i++) {
            for (Integer j = i + 1; j < accList.size(); j++) {
                accPairList.add(new AccountPair('', accList[i], accList[j]));
            }
        }
        return accPairList;
    }

    // --- –ü–æ–±—É–¥–æ–≤–∞ –ø–∞—Ä –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∞–∫–∞—É–Ω—Ç–∞ –∑ —É—Å—ñ–º–∞ —ñ–Ω—à–∏–º–∏ ‚Äî –∑–Ω–∞—î–º–æ Id ---
    public static List<AccountPair> getAccPairList(List<Account> accList, Id mainAccId) {
        List<AccountPair> accPairList = new List<AccountPair>();

        if (accList == null || accList.isEmpty() || mainAccId == null) {
            System.debug('‚ùå ERROR: List or mainAccId is invalid!');
            return accPairList;
        }

        Account mainAcc = null;
        for (Account acc : accList) {
            if (acc.Id == mainAccId) {
                mainAcc = acc;
                break;
            }
        }

        if (mainAcc == null) {
            System.debug('‚ùå ERROR: Main account with given Id not found in the list!');
            return accPairList;
        }

        return buildPairsWithMain(mainAcc, accList);
    }

    // --- –ü–æ–±—É–¥–æ–≤–∞ –ø–∞—Ä –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∞–∫–∞—É–Ω—Ç–∞ –∑ —É—Å—ñ–º–∞ —ñ–Ω—à–∏–º–∏ ‚Äî –∑–Ω–∞—î–º–æ —Å–∞–º –æ–±'—î–∫—Ç ---
    public static List<AccountPair> getAccPairList(Account mainAcc, List<Account> accList) {
        if (mainAcc == null || accList == null || accList.isEmpty()) {
            System.debug('‚ùå ERROR (getAccPairList): Arguments are invalid!');
            return new List<AccountPair>();
        }

        return buildPairsWithMain(mainAcc, accList);
    }

    // --- –ü—Ä–∏–≤–∞—Ç–Ω–∏–π –¥–æ–ø–æ–º—ñ–∂–Ω–∏–π –º–µ—Ç–æ–¥ –¥–ª—è —Ñ–æ—Ä–º—É–≤–∞–Ω–Ω—è –ø–∞—Ä ---
    private static List<AccountPair> buildPairsWithMain(Account mainAcc, List<Account> accList) {
        List<AccountPair> result = new List<AccountPair>();
        for (Account acc : accList) {
            if (acc.Id != mainAcc.Id) {
                result.add(new AccountPair('', mainAcc, acc));
            }
        }
        return result;
    }

    //-- –Ü–Ω–≤–µ—Ä—Ç—É—î–º–æ levensteinScore ---
    private static Decimal invLenevsteinScore(Decimal levensteinScore) {
            return (1.000 - levensteinScore).setScale(3);
    }

    // --- –û–±—Ä–∞—Ö–æ–≤—É—î –º–µ—Ç—Ä–∏–∫–∏ —Å—Ö–æ–∂–æ—Å—Ç—ñ –π –∑–∞–ø–∏—Å—É—î —ó—Ö —É AccountPair ---
    public static void compareNames(List<AccountPair> accountPairs, WeightSet weights) 
    {
        if (accountPairs == null || accountPairs.isEmpty()) {
            System.debug('‚ùå ERROR: List of arguments is invalid!');
            return;
        }

        for (AccountPair accPair : accountPairs) {
            String name1 = '';
            String name2 = '';
            if(accPair.acc1!=null && accPair.acc2!=null) {
                // –ë—É–≤ –ø–æ—à—É–∫ –ø–æ Id - –º–∞—î–º–æ –ø–∞—Ä—É –æ–±'—î–∫—Ç—ñ–≤ Account
                name1 = StringUtilsEx.getClearName(accPair.acc1.Name, TO_UPPER_CASE);
                name2 = StringUtilsEx.getClearName(accPair.acc2.Name, TO_UPPER_CASE);
            } else {
                if(accPair.acc1!=null && !String.isBlank(accPair.sourceName)) {
                    // –ë—É–≤ –ø–æ—à—É–∫ –ø–æ –Ω–∞–∑–≤—ñ (—á–∞—Å—Ç–∏–Ω—ñ –Ω–∞–∑–≤–∏) - –º–∞—î–º–æ –ø–∞—Ä—É + –æ–±'—î–∫—Ç Account
                    name1 = StringUtilsEx.getClearName(accPair.sourceName, TO_UPPER_CASE);
                    name2 = StringUtilsEx.getClearName(accPair.acc1.Name, TO_UPPER_CASE);
                }
            }

            Decimal jaccardScore = 0, levensteinScore = 0, metaphoneScore = 0, diceScore = 0, cosineScore = 0, soundexScore = 0, finalScore = 0;

            if (!String.isBlank(name1) && !String.isBlank(name2)) {
                // –Ø–∫—â–æ –Ω–∞–∑–≤–∏ –≤ —Ä—ñ–∑–Ω–∏—Ö –∞–±–µ—Ç–∫–∞—Ö - –ø—Ä–∏–º—É—Å–æ–≤–æ —Ç—Ä–∞–Ω—Å–ª—ñ—Ç–µ—Ä—É—î–º–æ –¥–æ –ª–∞—Ç–∏–Ω–∫–∏
                String alpha1 = StringUtilsEx.detectAlphabet(name1);
                String alpha2 = StringUtilsEx.detectAlphabet(name2);
                if (alpha1 != alpha2) {
                    if (alpha1 == 'Cyrillic' && alpha2 == 'Latin') {
                        name1 = StringUtilsEx.transliterateCyrillicToLatin(name1);
                    } else if (alpha2 == 'Cyrillic' && alpha1 == 'Latin') {
                          name2 = StringUtilsEx.transliterateCyrillicToLatin(name2);
                      } else {
                            name1 = StringUtilsEx.transliterateCyrillicToLatin(name1);
                            name2 = StringUtilsEx.transliterateCyrillicToLatin(name2);
                        }
                    
                }
                // –û–±—Ä–∞—Ö–æ–≤—É—î–º–æ match-—ñ–Ω–¥–µ–∫—Å–∏
                jaccardScore = StringUtilsEx.JaccardSimilarity(name1, name2, 2);
                levensteinScore = invLenevsteinScore(StringUtilsEx.getNormalizedLevenstein(name1, name2));
                metaphoneScore = MetaphoneUtils.getWordLevelSimilarity(name1, name2);
                diceScore = StringUtilsEx.DiceSimilarity(name1, name2);
                cosineScore = StringUtilsEx.CosineSimilarity(name1, name2);
                soundexScore = StringUtilsEx.compareSoundexFull(name1, name2);

                System.debug('jaccardScore: ' + jaccardScore);
                System.debug('levensteinScore: ' + levensteinScore);
                System.debug('metaphoneScore: ' + metaphoneScore);
                System.debug('diceScore: ' + diceScore);
                System.debug('cosineScore: ' + cosineScore);
                System.debug('soundexScore: ' + soundexScore);

                finalScore = (
                    jaccardScore * weights.jacWeight +
                    levensteinScore * weights.levWeight +
                    metaphoneScore * weights.metWeight +
                    diceScore * weights.dicWeight +
                    cosineScore * weights.cosWeight +
                    soundexScore * weights.sndWeight
                );
            }

            accPair.jaccardScore = jaccardScore.setScale(3);
            accPair.levensteinScore = levensteinScore.setScale(3);
            accPair.metaphoneScore = metaphoneScore.setScale(3);
            accPair.diceScore = diceScore.setScale(3);
            accPair.cosineScore = cosineScore.setScale(3);
            accPair.soundexScore = soundexScore.setScale(3);
            accPair.finalScore = finalScore.setScale(3);
            accPair.ScoreVerdict = getScoreVerdict(finalScore.setScale(3));
        }
    }

    public static String getScoreVerdict(Decimal finalScore) {
        String matchLevel = '';
        if(finalScore<0.0 || finalScore==null || finalScore>1.002) {
            System.debug('‚ùå ERROR: Argument is incorrect');
            return '';
        }
        if(finalScore>=0.000 && finalScore<=0.200) {
            matchLevel = 'NOT MATCH';
        }
        if(finalScore>0.200 && finalScore<=0.400) {
            matchLevel = 'LOW MATCH';
        }
        if(finalScore>0.400 && finalScore<=0.600) {
            matchLevel = 'MIDDLE MATCH';
        }
        if(finalScore>0.600 && finalScore<=0.800) {
            matchLevel = 'HIGH MATCH';
        }
        if(finalScore>0.800) {
            matchLevel = 'STRONG MATCH';
        }
        return matchLevel;
    }

    /***** –û—Å–Ω–æ–≤–Ω–∏–π –º–µ—Ç–æ–¥, —â–æ –ø–æ–≤–µ—Ä—Ç–∞—î –ª–∏—Å—Ç –æ–±'—î–∫—Ç—ñ–≤  MatchAccountsPair__c *****/
    /***************************************************************************/
    //  –ü–∞—Ä–∞–º–µ—Ç—Ä Boolean getAccMethodType –≤–∏–∑–Ω–∞—á–∞—î, —è–∫–∏–º –º–µ—Ç–æ–¥–æ –æ—Ç—Ä–∏–º—É—î–º–æ –ª–∏—Å—Ç –∞–∫–∞—É–Ω—Ç—ñ–≤
    //  –¶—ñ –∑–Ω–∞—á–µ–Ω–Ω—è –Ω–∞–ø–µ—Ä–µ–¥ –∑–∞–¥–∞–Ω–æ –≤ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞—Ö
    //  - BY_SELECT = true (—Å—Ç–∞—Ä–∏–π –º–µ—Ç–æ–¥, —â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î SOQL SELECT)
    //  - BY_APEX = false (–Ω–æ–≤–∏–π –º–µ—Ç–æ–¥ –±–µ–∑ –≤–∏–∫–æ—Ä–∏—Å—Ç–≤–Ω–Ω—è SOQL SELECT, —Ç—ñ–ª—å–∫–∏ –∫–æ–¥–æ–º Apex)
    //-------------------------------------------------------------------------------------
    public static List<MatchAccountsPair__c> getMatchAccounts(Boolean getAccMethodType, Boolean matchType, String sourceName,
                                                              Boolean typeIdForMatch, String strIdForFind,
                                                              Boolean bFirstWordsOnly, Boolean bUseTranslit,
                                                              WeightSet weights, Boolean insertObject) {
                                                                  
        List<MatchAccountsPair__c> resultPairList = new List<MatchAccountsPair__c>();
        
        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –∫–æ—Ä–µ–∫—Ç–Ω—ñ—Å—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤
        if(matchType==FIND_BY_CODE) {
            System.debug('–ü–æ—à—É–∫ –ø–æ –∫–æ–¥—É');
            if(typeIdForMatch==FIND_BY_SF_ID) {
                System.debug('FIND_BY_SF_ID');
                System.debug('typeIdForMatch==FIND_BY_SF_ID : ' + (typeIdForMatch==FIND_BY_SF_ID));
                if(!StringUtilsEx.isValidSalesforceId(strIdForFind)) {
                    System.debug('‚ùå ERROR: Salesforce Id is invalid');
                    return resultPairList;
                }
            } else if(typeIdForMatch==FIND_BY_ID_ERP) {
                System.debug('FIND_BY_ID_ERP');
                System.debug('typeIdForMatch==FIND_BY_ID_ERP : ' + (typeIdForMatch==FIND_BY_ID_ERP));
                if(!strIdForFind.isNumeric()) {
                    System.debug('‚ùå ERROR: ID_ERP__c is invalid');
                    return resultPairList;
                }
            }       
        } else {
            if(String.isBlank(sourceName)){
                System.debug('‚ùå ERROR: Parameter "Source Name" is invalid');
                return resultPairList;
            }
        }
        
        List<Account> accList = new List<Account>();
        // –û—Ç—Ä–∏–º—É—î–º–æ –ª–∏—Å—Ç –∞–∫–∞—É–Ω—Ç—ñ–≤
        if(getAccMethodType == BY_SELECT) {
            accList = new List<Account>(StringUtilsEx.GetAccountsList(matchType, typeIdForMatch, strIdForFind,
                                                                                sourceName, bFirstWordsOnly, bUseTranslit));
        } else {
            accList = new List<Account>(StringUtilsEx.getAccountList(matchType, typeIdForMatch, strIdForFind,
                                                                                sourceName, bFirstWordsOnly));          
        }
        
        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –∫–æ—Ä–µ–∫—Ç–Ω—ñ—Å—Ç—å –æ—Ç—Ä–∏–º–∞–Ω–æ–≥–æ –ª–∏—Å—Ç–∞ –∞–∫–∞—É–Ω—Ç—ñ–≤
        if(accList.isEmpty() || accList==null) {
            System.debug('‚ùå ERROR: Resulting List<Account> is empty!');
            return resultPairList;          
        }
        
        
        List<AccountPair> pairList = new List<AccountPair>();
        // –í–∏–∑–Ω–∞—á–∞—î–º–æ —Ç–∏–ø –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞ AccountPair      
        if(matchType==FIND_BY_NAME) { // –ü–æ—à—É–∫ –ø–æ –Ω–∞–∑–≤—ñ
            // –§–æ—Ä–º—É—î–º–æ –ª–∏—Å—Ç –ø–∞—Ä –∑–±—ñ–≥—ñ–≤ - —Ä—è–¥–æ–∫ –Ω–∞–∑–≤–∏ + List<Account> 
            pairList = new List<AccountPair>(getAccPairList(sourceName, accList));
        } else if(matchType==FIND_BY_CODE) { // –ü–æ—à—É–∫ –ø–æ –∫–æ–¥—É
            Account mainAcc = new Account();
            if(typeIdForMatch==FIND_BY_SF_ID) {
                mainAcc = AccountRepository.getById((Id)strIdForFind);                             
            } else if((typeIdForMatch==FIND_BY_ID_ERP)) {
                mainAcc = AccountRepository.getByErp(strIdForFind);
            }
            // –§–æ—Ä–º—É—î–º–æ –ª–∏—Å—Ç –ø–∞—Ä –∑–±—ñ–≥—ñ–≤ - mainAcc + List<Account>               
            pairList = new List<AccountPair>(getAccPairList(mainAcc, accList)); 
        }

        if(!pairList.isEmpty() && pairList!=null) {
            compareNames(pairList, weights);
            for(AccountPair pairRec : pairList) {
                MatchAccountsPair__c matchRec = new MatchAccountsPair__c();
                matchRec.sourceString__c = (String.isBlank(pairRec.sourceName)) ? '' : pairRec.sourceName;
                matchRec.Account1__c = (pairRec.acc1==null) ? null : pairRec.acc1.Id;
                matchRec.Account2__c = (pairRec.acc2==null) ? null : pairRec.acc2.Id;
                matchRec.jaccardScore__c = pairRec.jaccardScore;
                matchRec.levensteinScore__c = pairRec.levensteinScore;
                matchRec.metaphoneScore__c = pairRec.metaphoneScore;
                matchRec.diceScore__c = pairRec.diceScore;
                matchRec.cosineScore__c = pairRec.cosineScore;
                matchRec.soundexScore__c = pairRec.soundexScore;
                matchRec.finalScore__c = pairRec.finalScore;
                matchRec.ScoreVerdict__c = pairRec.ScoreVerdict;
                resultPairList.add(matchRec);
            }
            if(insertObject) insert resultPairList;
        } else {
            System.debug('‚ùå ERROR: Resulting object is empty!'); 
        }

        System.debug('üí• –ó–Ω–∞–π–¥–µ–Ω—ñ –ø–∞—Ä–∏ –¥—É–±–ª—ñ–≤:');
        for (MatchAccountsPair__c rec : resultPairList) {
            System.debug('‚û° ' + rec.Account1__c + ' vs ' + rec.Account2__c +
                    ' | finalScore: ' + rec.finalScore__c +
                    ' | Jaccard: ' + rec.jaccardScore__c +
                    ' | Levenshtein: ' + rec.levensteinScore__c);
        }

        return resultPairList;      
    }       
    
    /***************************************************************/   
    // --- –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –ø–∞—Ä–∏ –∞–∫–∞—É–Ω—Ç—ñ–≤ —ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ ---
    /***************************************************************/
    public class AccountPair {
        public String sourceName;
        public Account acc1;
        public Account acc2;
        public Decimal jaccardScore;
        public Decimal levensteinScore;
        public Decimal metaphoneScore;
        public Decimal diceScore;
        public Decimal cosineScore;
        public Decimal soundexScore;
        public Decimal finalScore;
        public String ScoreVerdict;

        public AccountPair(String sourceName, Account a1, Account a2) {
            this.sourceName = sourceName;
            this.acc1 = a1;
            this.acc2 = a2;
            this.jaccardScore = 0;
            this.levensteinScore = 0;
            this.metaphoneScore = 0;
            this.diceScore = 0;
            this.cosineScore = 0;
            this.soundexScore = 0;
            this.finalScore = 0;
            this.ScoreVerdict = '';
        }

        public AccountPair(String sourceName, Account a1, Account a2, Decimal j, Decimal l, Decimal m, 
                           Decimal d, Decimal c, Decimal sndScore, Decimal f, String ScoreVerdict) {
            this.sourceName = sourceName;
            this.acc1 = a1;
            this.acc2 = a2;
            this.jaccardScore = (j != null ? j.setScale(3) : 0).setScale(3);
            this.levensteinScore = (l != null ? l.setScale(3) : 0).setScale(3);
            this.metaphoneScore = (m != null ? m.setScale(3) : 0).setScale(3);
            this.diceScore = (d != null ? d.setScale(3) : 0).setScale(3);
            this.cosineScore = (c != null ? c.setScale(3) : 0).setScale(3);
            this.soundexScore = (sndScore != null ? sndScore.setScale(3) : 0).setScale(3);
            this.finalScore = (f != null ? f.setScale(3) : 0).setScale(3);          
            this.ScoreVerdict = getScoreVerdict((f != null ? f.setScale(3) : 0).setScale(3));
        }
    }
    
    
    //--- –ö–ª–∞—Å —ñ –º–µ—Ç–æ–¥ –¥–ª—è –ø–æ—à—É–∫—É –¥—É–±–ª—ñ–≤ —Å–µ—Ä–µ–¥ –Ω–∞—è–≤–Ω–∏—Ö –∞–∫–∞—É–Ω—Ç—ñ–≤
    public class MatchResult {
        public Id account1Id;
        public Id account2Id;
        public Decimal matchIndex;

        public MatchResult(Id a1, Id a2, Decimal idx) {
            this.account1Id = a1;
            this.account2Id = a2;
            this.matchIndex = idx;
        }
    }

    public static List<MatchResult> findPotentialDuplicates(Decimal threshold) {
        List<Account> accounts = [SELECT Id, Name, 
                                  PhoneticCode__c, MetaphonePrimary__c, MetaphoneAlternate__c,
                                  NYSIIS__c, SoundexAllWords__c
                                  FROM Account
                                  WHERE Name != null];

        List<MatchResult> results = new List<MatchResult>();

        for (Integer i = 0; i < accounts.size(); i++) {
            for (Integer j = i + 1; j < accounts.size(); j++) {
                Account a1 = accounts[i];
                Account a2 = accounts[j];

                Decimal matchIndex = StringUtilsEx.getCommonMatchIndex(
                    a1.PhoneticCode__c, a2.PhoneticCode__c,
                    a1.MetaphonePrimary__c, a2.MetaphonePrimary__c,
                    a1.MetaphoneAlternate__c, a2.MetaphoneAlternate__c,
                    a1.NYSIIS__c, a2.NYSIIS__c,
                    a1.SoundexAllWords__c, a2.SoundexAllWords__c
                );

                if (matchIndex >= threshold) {
                    results.add(new MatchResult(a1.Id, a2.Id, matchIndex));
                }
            }
        }

        return results;
    }    

    // –§—ñ–Ω–∞–ª—å–Ω–∏–π –º–µ—Ç–æ–¥ –ø–æ—à—É–∫—É –¥—ñ–±–ª—ñ–≤
    public static List<StringUtilsEx.MatchResult> finalDuplicateCheck(Boolean findType, String sourceName, Boolean findCodeType, 
                                      String code_ID_ERP, String code_SF_Id, Decimal threshold, 
                                      Boolean insertObject, IndexWeights idxWeights, WeightSet pairWeights) {
                                          
        List<StringUtilsEx.MatchResult> resultList = new List<StringUtilsEx.MatchResult>();
        Account acc = new Account();
        Id sourceAccId = null;
        // 1. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤                                  
        if (findType == Consts.FIND_BY_NAME) { // –ü–æ—à—É–∫ –ø–æ –¥–æ–≤—ñ–ª—å–Ω—ñ–π –Ω–∞–∑–≤—ñ —á–∏ —á–∞—Å—Ç–∏–Ω—ñ –Ω–∞–∑–≤–∏
            if(String.isBlank(sourceName)) {
                System.debug('‚ùåERROR! Source Name is invalid!');
                return resultList;
            }
        }
        if(findType == Consts.FIND_BY_CODE) {
            if(findCodeType == Consts.FIND_BY_SF_ID) {
                if(!StringUtilsEx.isValidSalesforceId(code_SF_Id)) {
                    System.debug('‚ùåERROR! Salesforce Id is invalid!');
                    return resultList;              
                }
            }
            if(findCodeType == Consts.FIND_BY_ID_ERP) {
                if(!code_ID_ERP.isNumeric()) {
                    System.debug('‚ùåERROR! Code ID_ERP__c is invalid!');
                    return resultList;                  
                }
            }       
        }
        if (threshold == null || threshold < 0.0 || threshold > 1.001) {
            System.debug('‚ö†Ô∏èWARNING! Parameter threshold was set to default: 0.600');
            threshold = 0.6;
        }
        if(idxWeights == null) {
            System.debug('‚ö†Ô∏èWARNING! IndexWeights was set to default: 0.600');
            idxWeights = IndexWeights.getDefault(); 
        }
        if(pairWeights == null) {
            System.debug('‚ö†Ô∏èWARNING! WeightSet was set to default: 0.600');
            pairWeights = WeightSet.getDefault();
        }

        // 2. –î–∂–µ—Ä–µ–ª–æ –ø–æ—à—É–∫—É - –ø–æ –∫–æ–¥—É. –û—Ç—Ä–∏–º—É—î–º–æ –Ω–∞–∑–≤—É –¥–ª—è –ø–æ—à—É–∫—É
        if (findType == Consts.FIND_BY_CODE) {
            acc = (findCodeType == Consts.FIND_BY_ID_ERP)
                ? AccountRepository.getByErp(code_ID_ERP)
                : AccountRepository.getById(code_SF_Id);

            sourceName = acc.Name;
            sourceAccId = acc.Id;
        }   
        
        // 3. –ù–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—è –Ω–∞–∑–≤–∏
        String normalizedName = StringUtilsEx.getClearName(sourceName, true);
        if (StringUtilsEx.detectAlphabet(normalizedName) != Consts.LAT) {
            normalizedName = StringUtilsEx.transliterateCyrillicToLatin(normalizedName);
        } else {
            //normalizedName = StringUtilsEx.clearDiphthongs(normalizedName);
            normalizedName = StringUtilsEx.normalizeDiacritics(normalizedName);
        }   
        
        // 4. –û—Ç—Ä–∏–º–∞–Ω–Ω—è —ñ–Ω–¥–µ–∫—Å—ñ–≤
        String sourcePhonetic     = PhoneticTranscoder.toPhoneticCode(normalizedName);
        String sourceNYSIIS       = StringUtilsEx.getNYSIIS(normalizedName);
        String sourceSoundexAll   = String.join(StringUtilsEx.getSoundexEx(normalizedName), ' ');
        MetaphoneUtils.MetaphoneResult mphSource = MetaphoneUtils.getMetaphoneFull(normalizedName);

        System.debug('üìä sourcePhonetic: ' + sourcePhonetic);
        System.debug('üìä Soundex: ' + sourceSoundexAll);
        System.debug('üìä NYSIIS: ' + sourceNYSIIS);
        System.debug('üìä Metaphone: ' + mphSource.primary + ', ' + mphSource.alternate);


        // 5. Soundex3 –∫–æ–∂–Ω–æ–≥–æ —Å–ª–æ–≤–∞ –ø–æ—á–∞—Ç–∫–æ–≤–æ—ó –Ω–∞–∑–≤–∏
        List<String> sourceSoundex3List = new List<String>();
        for (String word : normalizedName.split(' ')) {
            sourceSoundex3List.add(StringUtilsEx.soundex(word).left(3));
        }

        // 6. –û—Ç—Ä–∏–º–∞–Ω–Ω—è –≤—Å—ñ—Ö –ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω–∏—Ö –¥—É–±–ª—ñ–≤ (–ø–æ Soundex3) —á–µ—Ä–µ–∑ –æ–¥–∏–Ω SOQL
        Set<String> uniqueCodes = new Set<String>(sourceSoundex3List);
        List<Account> accListAll = [
            SELECT Id, Name, PhoneticCode__c, MetaphonePrimary__c, MetaphoneAlternate__c,
                   NYSIIS__c, SoundexAllWords__c, SoundexFirst3Letters__c
            FROM Account
            WHERE SoundexFirst3Letters__c IN :uniqueCodes
        ];

        System.debug('SEVEN');
        // 7. –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è —á–µ—Ä–µ–∑ —É—Ç–∏–ª—ñ—Ç—É compareAllToOne
        resultList = StringUtilsEx.compareAllToOne(
            accListAll,
            SourceName,
            sourceAccId,
            findType,
            sourcePhonetic,
            mphSource.primary,
            mphSource.alternate,
            sourceNYSIIS,
            sourceSoundexAll,
            idxWeights,
            threshold,
            insertObject
        );
        
        // 8. –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –∑–Ω–∞–π–¥–µ–Ω—ñ –∑–±—ñ–≥–∏
        return resultList;
    }
    
    //--- –®–≤–∏–¥–∫–∏–π –º–µ—Ç–æ–¥ –ø–æ—à—É–∫—É –¥—É–±–ª—ñ–≤ –ø–æ –Ω–∞—è–≤–Ω–∏—Ö —Ñ–æ–Ω–µ—Ç. –∫–æ–¥–∞—Ö —ñ –Ω–æ—Ä–º –Ω–µ–π–º–∞—Ö –≤ –ø–æ–ª—è—Ö Account
    public static List<StringUtilsEx.MatchResult> fastDuplicateCheck(String sourceName, Decimal threshold) {

        List<StringUtilsEx.MatchResult> resultList = new List<StringUtilsEx.MatchResult>();

        if(String.isBlank(sourceName)) {
            System.debug('‚ùåERROR! Source Name is invalid!');
            return resultList;
        }

        if (threshold == null || threshold < 0.0 || threshold > 1.000) {
            System.debug('‚ö†Ô∏èWARNING! Parameter threshold was set to default: 0.8');
            threshold = 0.8;
        }
        String s = StringNormalize.getClearName(sourceName, Consts.ToUpperCase.YES,
                                                Consts.QuestionMarkRule.REMOVE_SIGN,
                                                Consts.ClearCountryName.NO);
        String sourceSoundexAll = String.join(StringUtilsEx.getSoundexEx(s), ' ');
        String sourceNysiisAll = StringUtilsEx.getNYSIIS(s);
        String sourcePhonetic  = PhoneticTranscoder.toPhoneticCode(s);
        MetaphoneUtils.MetaphoneResult mphResult = MetaphoneUtils.getMetaphoneFull(s);

        String sourceSoundex3 = sourceSoundexAll.left(3);
        List<Account> accList = AccountRepository.getAllAccounts();
        List<Account> matchAccList = AccountRepository.getByFieldValue('SoundexFirst3Letters__c', sourceSoundex3);
        if(matchAccList.isEmpty()) {
            System.debug('No match results');
            return resultList;
        }

        Integer lenS = s.length();
        String strAcc = '';
        String accSoundex = '';
        String accNysiis = '';
        String accPhonetic = '';
        MetaphoneUtils.MetaphoneResult accMetaphone = new MetaphoneUtils.MetaphoneResult();
        for(Account acc : matchAccList) {
            if(acc.NormalizedName__c.length()>lenS) {
                strAcc = acc.NormalizedName__c.substring(0,lenS);
            } else {
                strAcc = acc.NormalizedName__c;
            }
            accSoundex = String.join(StringUtilsEx.getSoundexEx(strAcc), ' ');
            accNysiis = StringUtilsEx.getNYSIIS(strAcc);
            accPhonetic = PhoneticTranscoder.toPhoneticCode(strAcc);
            accMetaphone = MetaphoneUtils.getMetaphoneFull(strAcc);

            Decimal sndIx = StringUtilsEx.compareSoundexAllCodes(sourceSoundexAll, accSoundex);
            Decimal nysIdx = StringUtilsEx.compareNysiisWords(sourceNysiisAll, accNysiis,
                                                              StringUtilsEx.getNysiisCache(sourceNysiisAll, accNysiis));
            Set<String> allCodes = new Set<String>();
            allCodes.add(sourcePhonetic);
            allCodes.add(accPhonetic);
            Map<String, Set<String>> bigramsMap = PhoneticTranscoder.buildBigramsCache(new List<String>(allCodes));
            Map<String, Set<String>> lettersMap = PhoneticTranscoder.buildLettersCache(new List<String>(allCodes));
            Decimal phnIdx = PhoneticTranscoder.comparePhoneticHybridCached(sourcePhonetic, accPhonetic, bigramsMap, lettersMap);

            // - —Å–µ—Ç–∏ –¥–ª—è –∫–æ–¥—ñ–≤ Metaphone
            Set<String> mphCodes1 = new Set<String>();
            Set<String> mphCodes2 = new Set<String>();

            // - –∑–∞–ø–æ–≤–Ω—é—î–º–æ —Å–µ—Ç–∏ –∫–æ–¥–∞–º–∏
            mphCodes1.add(mphResult.primary);
            mphCodes1.add(mphResult.alternate);

            mphCodes2.add(accMetaphone.primary);
            mphCodes2.add(accMetaphone.alternate);

            Decimal mphIdx = MetaphoneUtils.compareMetaphoneLetterSets(mphCodes1, mphCodes2);

            Decimal resIdx = (sndIx + nysIdx + phnIdx + mphIdx)/4.0;
            if(resIdx >= threshold) {
                StringUtilsEx.MatchResult resRec = new StringUtilsEx.MatchResult(sourceName, acc.Id, null, resIdx.setScale(3));
                resultList.add(resRec);
            }
        }
        return resultList;
    }

    //--- –û–±—Ä–∞—Ö–æ–≤—É—î–º–æ —ñ–Ω—Ç–µ–≥—Ä–æ–≤–∞–Ω–∏–π match-—ñ–Ω–¥–µ–∫—Å:
    //    Jaccard, Norm Levenstein, Dice, Cosine, Soundex (JLDCS)
    public static Decimal getIntgratedMatchIndex(String name1, String name2, Boolean needNormalize) {
        if(String.isBlank(name1) || String.isBlank(name2)) return 0.000;
        String s1='';
        String s2='';
        if(needNormalize) {
            s1=StringNormalize.getClearName(name1, Consts.ToUpperCase.YES,
                                                        Consts.QuestionMarkRule.REMOVE_SIGN,
                                                        Consts.ClearCountryName.NO);
            s2=StringNormalize.getClearName(name2, Consts.ToUpperCase.YES,
                                                        Consts.QuestionMarkRule.REMOVE_SIGN,
                                                        Consts.ClearCountryName.NO);
        } else {
            s1 = name1;
            s2 = name2;
        }

        Decimal idxJaccard = ((SimilarityUtils.JaccardSimilarityByWords(s1, s2, false, false) +
                              SimilarityUtils.JaccardCharSimilarity(s1, s2) +
                              SimilarityUtils.JaccardSimilarity(s1, s2, 2))/3.0).setScale(3);
        Decimal idxDice = SimilarityUtils.DiceSimilarity(s1, s2, false, false);
        Decimal idxNormLev = (1.000 - (SimilarityUtils.getNormalizedLevenstein(s1, s2, false, false)));
        Decimal idxCosine = SimilarityUtils.CosineSimilarity(s1, s2, false, false);
        Decimal idxSoundex = SimilarityUtils.getFullSoundexSimilarity(s1, s2, false);

        Decimal idxFull = 0.2*(idxJaccard+idxDice+idxNormLev+idxCosine+idxSoundex).setScale(3);
        return idxFull;
    }
    
}
global class ScrapAdminLimitRequestService {

    global class CreatedBundle {
        @AuraEnabled global ScrapSupplierLimit__c parent;
        @AuraEnabled global List<SupplierLimitDetails__c> details;
    }

    global class DecadeLimitVM {
        @AuraEnabled global Id decadeId;          // Id –∑–∞–ø–∏—Å—É Decade (—Ä—ñ–≤–µ–Ω—å 3)
        @AuraEnabled global String decadeNumber; // 1/2/3 (–±–µ—Ä–µ–º–æ –∑ Decade__r.Decade__c, —è–∫—â–æ —î)
        @AuraEnabled global Decimal limitValue;        // –ª—ñ–º—ñ—Ç –ø–æ –¥–µ–∫–∞–¥—ñ
    }

    global class UnapprovedLimitRow {
        @AuraEnabled global Id parentId;
        @AuraEnabled global Datetime createdDate;          // NEW
        @AuraEnabled global Id supplierId;
        @AuraEnabled global String supplierName;
        @AuraEnabled global String yearTxt;
        @AuraEnabled global String monthTxt;
        @AuraEnabled global Integer monthNum;              // NEW (–∑ monthTxt)
        @AuraEnabled global Id monthLookupId;
        @AuraEnabled global Decimal monthTotal;

        // –ü–ª–æ—Å–∫—ñ –ø–æ–ª—è –¥–ª—è —Ç–∞–±–ª–∏—Ü—ñ —ñ –º–æ–¥–∞–ª–∫–∏ ‚Äî NEW
        @AuraEnabled global Id     detailDec1Id;
        @AuraEnabled global Id     detailDec2Id;
        @AuraEnabled global Id     detailDec3Id;
        @AuraEnabled global Decimal dec1;
        @AuraEnabled global Decimal dec2;
        @AuraEnabled global Decimal dec3;

        // –ó–∞–ª–∏—à–∞—î–º–æ —ñ –º–∞—Å–∏–≤ –Ω–∞ –≤–∏–ø–∞–¥–æ–∫, —è–∫—â–æ —Ç—Ä–µ–±–∞ –ø–æ–¥–µ–∫–∞–¥–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ
        @AuraEnabled global List<DecadeLimitVM> decades;
    }

    // ====== DTO for approve input/output ======
    global class ApproveInput {
        @AuraEnabled global Id supplierLimitId { get; set; }   // –±–∞—Ç—å–∫–æ –ó–∞—è–≤–ª–µ–Ω–∏–π
        @AuraEnabled global Id detailDec1Id { get; set; }
        @AuraEnabled global Id detailDec2Id { get; set; }
        @AuraEnabled global Id detailDec3Id { get; set; }
        @AuraEnabled global Decimal dec1 { get; set; }
        @AuraEnabled global Decimal dec2 { get; set; }
        @AuraEnabled global Decimal dec3 { get; set; }
        @AuraEnabled global String baseDoc;      // –æ–ø—Ü—ñ–π–Ω–æ: –ø—ñ–¥—Å—Ç–∞–≤–∞ (—Ç–µ–∫—Å—Ç)
        @AuraEnabled global String docLinkId;    // –æ–ø—Ü—ñ–π–Ω–æ: –ª—ñ–Ω–∫-–¥–æ–∫ (—Ç–µ–∫—Å—Ç/Id)
    }

    global class ApproveResult {
        @AuraEnabled global Boolean success { get; set; }
        @AuraEnabled global String  message { get; set; }
        @AuraEnabled global Id      approvedParentId { get; set; }
        @AuraEnabled global List<Id> approvedDetailIds { get; set; }
    }


    // ====== CREATE (–∑–∞–ª–∏—à–∞—î–º–æ —è–∫ –ø–æ–≥–æ–¥–∂–µ–Ω–æ) ======

    @AuraEnabled
    global static CreatedBundle createProposedForCurrentMonth(
            Id supplierId,
            Decimal dec1Limit,
            Decimal dec2Limit,
            Decimal dec3Limit
    ) {
        if (supplierId == null) throw new AuraHandledException('–ü–æ—Ç—Ä—ñ–±–µ–Ω supplierId.');

        Date today      = System.today();
        Integer yearNum = today.year();
        Integer monthNum= today.month();

        // –¢–≤—ñ–π —Å—Ç–∏–ª—å –±—ñ–Ω–¥–∏–Ω–≥—É –≤ Decade__c: Year__c —è–∫ Decimal, Month__c —è–∫ String
        Decimal y = Decimal.valueOf(yearNum);
        String  m = String.valueOf(monthNum);

        // 1) –ú—ñ—Å—è—á–Ω–∏–π –≤—É–∑–æ–ª (Level__c = 2) ‚Äî –±–µ—Ä–µ–º–æ –æ–¥–∏–Ω, —è–∫ —É —Ç–≤–æ—î–º—É –∞–Ω–æ–Ω—ñ–º—É—Å—ñ
        Decade__c monthNode = [
                SELECT Id, Name
                FROM Decade__c
                WHERE Year__c = :y AND Month__c = :m AND Level__c = 2
                LIMIT 1
        ];
        System.debug('Month node: ' + monthNode.Name);

        // 2) –¢—Ä–∏ –¥–µ–∫–∞–¥–∏ ‚Äî –¥—ñ—Ç–∏ –º—ñ—Å—è—Ü—è; –≤–ø–æ—Ä—è–¥–∫—É—î–º–æ –∑–∞ –Ω–æ–º–µ—Ä–æ–º
        List<Decade__c> threeDecades = [
                SELECT Id, Decade__c
                FROM Decade__c
                WHERE Parent__c = :monthNode.Id
                ORDER BY Decade__c
                LIMIT 3
        ];
        System.debug('threeDecades: ' + threeDecades);

        // 3) –í–∏–∑–Ω–∞—á–∞—î–º–æ Record Type –¥–ª—è "–ó–∞—è–≤–ª–µ–Ω–∏–π"
        Id proposedRtId = getProposedRecordTypeId();

        // 4) –°—Ç–≤–æ—Ä—é—î–º–æ –±–∞—Ç—å–∫—ñ–≤—Å—å–∫–∏–π ScrapSupplierLimit__c
        ScrapSupplierLimit__c parent = new ScrapSupplierLimit__c();
        parent.Supplier__c      = supplierId;
        parent.YearPick__c      = String.valueOf(yearNum);   // —è–∫—â–æ Picklist/—Ç–µ–∫—Å—Ç
        parent.Month__c         = String.valueOf(monthNum);  // —è–∫—â–æ Picklist —ñ–∑ –Ω–æ–º–µ—Ä–æ–º
        parent.RecordTypeId     = proposedRtId;              // "–ó–∞—è–≤–ª–µ–Ω–∏–π"
        parent.SentToApprove__c = false;
        parent.Approved__c      = false;
        parent.MonthLookup__c   = monthNode.Id;
        insert parent;
        System.debug('Created ScrapSupplierLimit__c: ' + parent.Id);

        // 5) –î–µ—Ç–∞–ª—ñ (—ñ–∑ —Ñ—Ä–æ–Ω—Ç–∞)
        List<SupplierLimitDetails__c> toInsert = new List<SupplierLimitDetails__c>{
            buildDetail(parent.Id, monthNode.Id, threeDecades[0].Id, dec1Limit == null ? 0 : dec1Limit),
            buildDetail(parent.Id, monthNode.Id, threeDecades[1].Id, dec2Limit == null ? 0 : dec2Limit),
            buildDetail(parent.Id, monthNode.Id, threeDecades[2].Id, dec3Limit == null ? 0 : dec3Limit)
        };
        insert toInsert;

        System.debug('Created details: ' + toInsert);
        System.debug('Done. Parent.Key__c (—Ç—Ä–∏–≥–µ—Ä): ' + parent.Key__c);

        CreatedBundle out = new CreatedBundle();
        out.parent  = parent;
        out.details = toInsert;
        return out;
    }

    // ====== READ (—Ç—ñ–ª—å–∫–∏ –ù–ï–£–ó–ì–û–î–ñ–ï–ù–Ü –¥–ª—è —Å—Ç–æ—Ä—ñ–Ω–∫–∏/–º–æ–¥–∞–ª–∫–∏) ======

    @AuraEnabled(cacheable=false)
    global static List<UnapprovedLimitRow> listUnapprovedForCurrentMonth() {
        Date   today    = System.today();
        Integer yearNum = today.year();
        Integer monthNum= today.month();
        return listUnapprovedForPeriod(yearNum, monthNum);
    }

    @AuraEnabled(cacheable=false)
    global static List<UnapprovedLimitRow> listUnapprovedForPeriod(Integer yearNum, Integer monthNum) {
        if (yearNum == null || monthNum == null) {
            throw new AuraHandledException('–ü–æ—Ç—Ä—ñ–±–Ω—ñ —Ä—ñ–∫ —ñ –º—ñ—Å—è—Ü—å.');
        }

        // RecordType –¥–ª—è "–ó–∞—è–≤–ª–µ–Ω–∏–π" (–º–∏ –ø–æ–∫–∞–∑—É—î–º–æ –¢–Ü–õ–¨–ö–ò –Ω–µ—É–∑–≥–æ–¥–∂–µ–Ω—ñ, —è–∫ —Ç–∏ –ø—Ä–æ—Å–∏–ª–∞)
        Id proposedRtId = getProposedRecordTypeId();

        // –ë–∞—Ç—å–∫–∏: —Ç—ñ–ª—å–∫–∏ RT=–ó–∞—è–≤–ª–µ–Ω–∏–π —ñ Approved__c = false
        List<ScrapSupplierLimit__c> parents = [
            SELECT Id, CreatedDate, Supplier__c, Supplier__r.Name,
                   YearPick__c, Month__c, MonthLookup__c,
                   Approved__c, MonthLimit__c
            FROM ScrapSupplierLimit__c
            WHERE YearPick__c = :String.valueOf(yearNum)
              AND Month__c    = :String.valueOf(monthNum)
              AND RecordTypeId = :proposedRtId
              AND Approved__c = FALSE
            ORDER BY Supplier__r.Name NULLS LAST, CreatedDate ASC
        ];
        if (parents.isEmpty()) return new List<UnapprovedLimitRow>();

        // –í—Å—ñ –¥–µ—Ç–∞–ª—ñ –¥–ª—è —Ü–∏—Ö –±–∞—Ç—å–∫—ñ–≤
        List<SupplierLimitDetails__c> details = [
            SELECT Id, ScrapSupplierLimit__c, Limit__c,
                   Decade__c, Decade__r.Decade__c
            FROM SupplierLimitDetails__c
            WHERE ScrapSupplierLimit__c IN :parents
            ORDER BY Decade__r.Decade__c, CreatedDate
        ];

        // –ì—Ä—É–ø—É—î–º–æ –¥–µ—Ç–∞–ª—ñ –ø–æ –±–∞—Ç—å–∫—É
        Map<Id, List<SupplierLimitDetails__c>> byParent = new Map<Id, List<SupplierLimitDetails__c>>();
        for (ScrapSupplierLimit__c p : parents) {
            byParent.put(p.Id, new List<SupplierLimitDetails__c>());
        }

        for (SupplierLimitDetails__c d : details) {
            List<SupplierLimitDetails__c> bucket = byParent.get(d.ScrapSupplierLimit__c);
            if (bucket != null) bucket.add(d);
        }

        // –§–æ—Ä–º—É—î–º–æ ViewModel –¥–ª—è —Ñ—Ä–æ–Ω—Ç–∞
        List<UnapprovedLimitRow> rows = new List<UnapprovedLimitRow>();
        for (ScrapSupplierLimit__c p : parents) {
            UnapprovedLimitRow row = new UnapprovedLimitRow();
            row.parentId      = p.Id;
            row.createdDate   = p.CreatedDate;                         // NEW
            row.supplierId    = p.Supplier__c;
            row.supplierName  = p.Supplier__r == null ? null : p.Supplier__r.Name;
            row.yearTxt       = p.YearPick__c;
            row.monthTxt      = p.Month__c;
            row.monthNum = toIntSafe(p.Month__c);
            row.monthLookupId = p.MonthLookup__c;

            // –ø–æ–¥–µ–∫–∞–¥–Ω–æ
            row.decades = new List<DecadeLimitVM>();
            Decimal sum = 0;
            for (SupplierLimitDetails__c d : byParent.get(p.Id)) {
                DecadeLimitVM vm = new DecadeLimitVM();
                vm.decadeId     = d.Decade__c;
                vm.decadeNumber = (d.Decade__r == null ? null : d.Decade__r.Decade__c);
                vm.limitValue    = d.Limit__c;
                row.decades.add(vm);

                 Integer decNo = null;
                if (d.Decade__r != null && d.Decade__r.Decade__c != null) {
                    decNo = Integer.valueOf(String.valueOf(d.Decade__r.Decade__c));
                }
                if (decNo == 1) { row.detailDec1Id = d.Id; row.dec1 = d.Limit__c; }
                else if (decNo == 2) { row.detailDec2Id = d.Id; row.dec2 = d.Limit__c; }
                else if (decNo == 3) { row.detailDec3Id = d.Id; row.dec3 = d.Limit__c; }

                sum += (d.Limit__c == null ? 0 : d.Limit__c);
            }

            // –ø—ñ–¥—Å—É–º–æ–∫
            row.monthTotal = (p.MonthLimit__c != null ? p.MonthLimit__c : sum);

            rows.add(row);
        }
        return rows;
    }

    // ====== helpers ======

    private static SupplierLimitDetails__c buildDetail(
            Id parentId, Id monthLookupId, Id decadeId, Decimal limitValue
    ) {
        SupplierLimitDetails__c d = new SupplierLimitDetails__c();
        d.ScrapSupplierLimit__c = parentId;
        d.MonthLookup__c        = monthLookupId;
        d.Decade__c             = decadeId;
        d.Limit__c              = limitValue;
        return d;
    }

    /** –®—É–∫–∞—î–º–æ Record Type –¥–ª—è "–ó–∞—è–≤–ª–µ–Ω–∏–π" (Name='–ó–∞—è–≤–ª–µ–Ω–∏–π' –∞–±–æ DevName IN ('Proposed','Declared')). */
    private static Id getProposedRecordTypeId() {
        List<RecordType> rts = [
                SELECT Id, Name, DeveloperName
                FROM RecordType
                WHERE SobjectType = 'ScrapSupplierLimit__c'
                AND (Name = '–ó–∞—è–≤–ª–µ–Ω–∏–π' OR DeveloperName IN ('Proposed','Declared'))
                LIMIT 1
        ];
        if (rts.isEmpty()) {
            throw new AuraHandledException('Record Type "–ó–∞—è–≤–ª–µ–Ω–∏–π/Proposed/Declared" –¥–ª—è ScrapSupplierLimit__c –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.');
        }
        return rts[0].Id;
    }

    // ====== APPROVE: —Å—Ç–≤–æ—Ä—é—î–º–æ "–£–∑–≥–æ–¥–∂–µ–Ω–∏–π" + 3 –¥–æ—á—ñ—Ä–Ω—ñ ======
    @AuraEnabled
    global static ApproveResult approve(ApproveInput input) {
        System.debug('================approve====================');
        System.debug('DATA: ' + input);
        ApproveResult res = new ApproveResult();
        res.success = false;

        // 0) –í–∞–ª—ñ–¥–∞—Ü—ñ—è
        if (input == null || input.supplierLimitId == null)
            throw new AuraHandledException('–ù–µ –ø–µ—Ä–µ–¥–∞–Ω–æ supplierLimitId.');
        if (input.detailDec1Id == null || input.detailDec2Id == null || input.detailDec3Id == null)
            throw new AuraHandledException('–ü–æ—Ç—Ä—ñ–±–Ω—ñ –≤—Å—ñ —Ç—Ä–∏ detailDec*Id.');

        // 1) –ë–∞—Ç—å–∫–æ "–ó–∞—è–≤–ª–µ–Ω–∏–π"
        ScrapSupplierLimit__c proposed = [
                SELECT Id, Supplier__c, YearPick__c, Month__c, MonthLookup__c, RecordTypeId
                FROM ScrapSupplierLimit__c
                WHERE Id = :input.supplierLimitId
                LIMIT 1
        ];

        proposed.Approved__c = true;       // ‚úÖ —Å–∞–º–µ —Ç—É—Ç
        update proposed;


        // 2) –û—Ç—Ä–∏–º–∞—î–º–æ —Ç—Ä–∏ –¥–µ—Ç–∞–ª—ñ, —â–æ–± –∑–Ω—è—Ç–∏ —ó—Ö–Ω—ñ –î–ï–ö–ê–î–ò (—â–æ–± –Ω–µ –≤–≥–∞–¥—É–≤–∞—Ç–∏ –ø–æ—Ä—è–¥–æ–∫)
        Map<Id, SupplierLimitDetails__c> detailsById = new Map<Id, SupplierLimitDetails__c>([
                SELECT Id, ScrapSupplierLimit__c, Decade__c, MonthLookup__c, Limit__c
                FROM SupplierLimitDetails__c
                WHERE Id IN :new List<Id>{ input.detailDec1Id, input.detailDec2Id, input.detailDec3Id }
        ]);
        if (detailsById.size() != 3)
            throw new AuraHandledException('–ó–Ω–∞–π–¥–µ–Ω–æ –Ω–µ –≤—Å—ñ SupplierLimitDetails__c –∑–∞ –≤–∫–∞–∑–∞–Ω–∏–º–∏ Id.');

        // 3) –í–∏–∑–Ω–∞—á–∞—î–º–æ RT –¥–ª—è "–£–∑–≥–æ–¥–∂–µ–Ω–∏–π"
        Id approvedRtId = getApprovedRecordTypeId();

        // 4) –°—Ç–≤–æ—Ä—é—î–º–æ –±–∞—Ç—å–∫–∞ "–£–∑–≥–æ–¥–∂–µ–Ω–∏–π" (–∫–æ–ø—ñ—è –∫–ª—é—á–æ–≤–∏—Ö –ø–æ–ª—ñ–≤ —ñ–∑ "–ó–∞—è–≤–ª–µ–Ω–æ–≥–æ")
        ScrapSupplierLimit__c approved = new ScrapSupplierLimit__c();
        approved.Supplier__c    = proposed.Supplier__c;
        approved.YearPick__c    = proposed.YearPick__c;
        approved.Month__c       = proposed.Month__c;
        approved.MonthLookup__c = proposed.MonthLookup__c;
        approved.RecordTypeId   = approvedRtId;
        approved.SentToApprove__c = true;   // –∑–∞ –ø–æ—Ç—Ä–µ–±–∏
        approved.Approved__c      = true;
        insert approved;

        // 5) –ü—ñ–¥–≥–æ—Ç—É—î–º–æ –º–∞–ø—É "—è–∫–∏–π detailId ‚Üí —è–∫–µ –∑–Ω–∞—á–µ–Ω–Ω—è"
        Map<Id, Decimal> newLimitsByDetailId = new Map<Id, Decimal>{
                input.detailDec1Id => (input.dec1 == null ? 0 : input.dec1),
                input.detailDec2Id => (input.dec2 == null ? 0 : input.dec2),
                input.detailDec3Id => (input.dec3 == null ? 0 : input.dec3)
        };

        // 6) –°—Ç–≤–æ—Ä—é—î–º–æ 3 –Ω–æ–≤—ñ –¥–µ—Ç–∞–ª—ñ –¥–ª—è "–£–∑–≥–æ–¥–∂–µ–Ω–æ–≥–æ", –∑–±–µ—Ä—ñ–≥–∞—é—á–∏ —Ç—ñ –∂ –î–ï–ö–ê–î–ò
        List<SupplierLimitDetails__c> toIns = new List<SupplierLimitDetails__c>();
        for (Id oldDetailId : newLimitsByDetailId.keySet()) {
            SupplierLimitDetails__c oldD = detailsById.get(oldDetailId);
            SupplierLimitDetails__c nd = new SupplierLimitDetails__c();
            nd.ScrapSupplierLimit__c = approved.Id;
            nd.MonthLookup__c        = proposed.MonthLookup__c;  // –º—ñ—Å—è—á–Ω–∏–π –≤—É–∑–æ–ª —Ç–æ–π —Å–∞–º–∏–π
            nd.Decade__c             = oldD.Decade__c;           // –≤–∞–∂–ª–∏–≤–æ: —Ç–∞ –∂ –¥–µ–∫–∞–¥–∞
            nd.Limit__c              = newLimitsByDetailId.get(oldDetailId);
            toIns.add(nd);
        }
        insert toIns;

        // 7) (–û–ø—Ü—ñ–π–Ω–æ) ‚Äî –∑–∞—Ñ—ñ–∫—Å—É–≤–∞—Ç–∏ –∑–º—ñ–Ω–∏ —É SupplierLimitEdit__c (–ø–æ 3 –∑–∞–ø–∏—Å–∏),
        // —è–∫—â–æ —Ç–∏ –≤–∂–µ –ø—Ä–∞—Ü—é—î—à –∑ —Ü–∏–º –æ–±'—î–∫—Ç–æ–º —è–∫ –∑ –∂—É—Ä–Ω–∞–ª–æ–º –∑–º—ñ–Ω.
        // –¢—É—Ç –º–æ–∂–Ω–∞ –≤–∫–∞–∑–∞—Ç–∏ OriginalLimit__c = oldD.Limit__c; NewLimit__c = input.dec*;
        // BaseDoc__c / DocLinkId__c ‚Äî –∑ input.baseDoc / input.docLinkId.
        // –ó–∞ –ø–æ—Ç—Ä–µ–±–∏ ‚Äî –¥–æ–¥–∞–º, –∞–ª–µ –∑–∞—Ä–∞–∑ –∑–∞–ª–∏—à–∞—é —è–∫ –∫–æ–º–µ–Ω—Ç–∞—Ä.

        res.success = true;
        res.message = '–£–∑–≥–æ–¥–∂–µ–Ω–æ';
        res.approvedParentId = approved.Id;
        res.approvedDetailIds = new List<Id>();
        for (SupplierLimitDetails__c d : toIns) res.approvedDetailIds.add(d.Id);
        return res;
    }

// ====== helper: RecordType –¥–ª—è "–£–∑–≥–æ–¥–∂–µ–Ω–∏–π" ======
    private static Id getApprovedRecordTypeId() {
        List<RecordType> rts = [
                SELECT Id, Name, DeveloperName
                FROM RecordType
                WHERE SobjectType = 'ScrapSupplierLimit__c'
                AND (Name = '–£–∑–≥–æ–¥–∂–µ–Ω–∏–π' OR DeveloperName IN ('Approved'))
                LIMIT 1
        ];
        if (rts.isEmpty())
            throw new AuraHandledException('Record Type "–£–∑–≥–æ–¥–∂–µ–Ω–∏–π/Approved" –¥–ª—è ScrapSupplierLimit__c –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.');
        return rts[0].Id;
    }

    @AuraEnabled(cacheable=true)
    global static List<UnapprovedLimitRow> listUnapprovedForCurrentAndNext() {
        Date today = System.today();
        Integer y1 = today.year(), m1 = today.month();
        Date nxt   = today.addMonths(1);
        Integer y2 = nxt.year(),   m2 = nxt.month();

        Id proposedRtId = getProposedRecordTypeId();

        // 1) –ë–∞—Ç—å–∫–∏ –∑–∞ –æ–±–æ–º–∞ –º—ñ—Å—è—Ü—è–º–∏
        List<ScrapSupplierLimit__c> parents = [
                SELECT Id, CreatedDate, Supplier__c, Supplier__r.Name,
                        YearPick__c, Month__c, MonthLookup__c,
                        Approved__c, MonthLimit__c, RecordTypeId
                FROM ScrapSupplierLimit__c
                WHERE RecordTypeId = :proposedRtId
                AND (Approved__c = false OR Approved__c = null)
                AND (
                        (YearPick__c = :String.valueOf(y1) AND Month__c = :String.valueOf(m1)) OR
                        (YearPick__c = :String.valueOf(y2) AND Month__c = :String.valueOf(m2))
                )
                ORDER BY CreatedDate DESC, Supplier__r.Name NULLS LAST
                LIMIT 2000
        ];
        if (parents.isEmpty()) return new List<UnapprovedLimitRow>();

        // 2) –î–µ—Ç–∞–ª—ñ –≤—Å—ñ—Ö –∑–Ω–∞–π–¥–µ–Ω–∏—Ö –±–∞—Ç—å–∫—ñ–≤
        List<SupplierLimitDetails__c> details = [
                SELECT Id, ScrapSupplierLimit__c, Limit__c,
                        Decade__c, Decade__r.Decade__c
                FROM SupplierLimitDetails__c
                WHERE ScrapSupplierLimit__c IN :parents
                ORDER BY Decade__r.Decade__c, CreatedDate
        ];

        // 3) –ì—Ä—É–ø—É–≤–∞–Ω–Ω—è
        Map<Id, List<SupplierLimitDetails__c>> byParent = new Map<Id, List<SupplierLimitDetails__c>>();
        for (ScrapSupplierLimit__c p : parents) byParent.put(p.Id, new List<SupplierLimitDetails__c>());
        for (SupplierLimitDetails__c d : details) {
            List<SupplierLimitDetails__c> b = byParent.get(d.ScrapSupplierLimit__c);
            if (b != null) b.add(d);
        }

        // 4) –ü–æ–±—É–¥–æ–≤–∞ —Ä—è–¥–∫—ñ–≤
        List<UnapprovedLimitRow> rows = new List<UnapprovedLimitRow>();
        for (ScrapSupplierLimit__c p : parents) {
            UnapprovedLimitRow row = new UnapprovedLimitRow();
            row.parentId      = p.Id;
            row.createdDate   = p.CreatedDate;
            row.supplierId    = p.Supplier__c;
            row.supplierName  = (p.Supplier__r == null ? null : p.Supplier__r.Name);
            row.yearTxt       = p.YearPick__c;
            row.monthTxt      = p.Month__c;
            row.monthNum      = toIntSafe(p.Month__c);
            row.monthLookupId = p.MonthLookup__c;

            row.decades = new List<DecadeLimitVM>();
            Decimal sum = 0;
            for (SupplierLimitDetails__c d : byParent.get(p.Id)) {
                DecadeLimitVM vm = new DecadeLimitVM();
                vm.decadeId     = d.Decade__c;
                vm.decadeNumber = (d.Decade__r == null ? null : d.Decade__r.Decade__c); // üëà –¥–∏–≤. –ø.2
                vm.limitValue   = d.Limit__c;
                row.decades.add(vm);

                Integer decNo = null;
                if (d.Decade__r != null && d.Decade__r.Decade__c != null) {
                    decNo = Integer.valueOf(String.valueOf(d.Decade__r.Decade__c));
                }
                if (decNo == 1) { row.detailDec1Id = d.Id; row.dec1 = d.Limit__c; }
                else if (decNo == 2) { row.detailDec2Id = d.Id; row.dec2 = d.Limit__c; }
                else if (decNo == 3) { row.detailDec3Id = d.Id; row.dec3 = d.Limit__c; }

                sum += (d.Limit__c == null ? 0 : d.Limit__c);
            }

            row.monthTotal = (p.MonthLimit__c != null ? p.MonthLimit__c : sum);
            rows.add(row);
        }
        // –≤–∂–µ –≤—ñ–¥—Å–æ—Ä—Ç–æ–≤–∞–Ω–æ –ø–æ CreatedDate DESC —É SOQL; –∑–∞–ª–∏—à–∞—î–º–æ —è–∫ —î
        return rows;
    }

    private static Integer toIntSafe(String s) {
        if (String.isBlank(s)) return null;
        try { return Integer.valueOf(s.trim()); }
        catch (Exception e) { return null; }
    }


    public static void FakeCoverageMethod() {
        Integer i = 0;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;

    }
}
<template>
<template if:true={showEditModal}>
    <div class="modal-backdrop">
        <div class={modalContentClass} role="dialog" aria-modal="true" aria-labelledby="edit-modal-title" aria-busy={saving} tabindex="-1">
            <div class="modal-header">
                <h2 id="edit-modal-title">Редагування постачальника</h2>
            </div>

            <div class="modal-body">
                <!-- Інфоблок (тільки перегляд базових, без редагування на цьому кроці) -->
                <div class="info-grid">
                    <div class="info-field">
                        <label>Назва постачальника</label>
                        <lightning-formatted-text value={selected.name}></lightning-formatted-text>
                    </div>
                    <div class="info-field">
                        <label>Телефон</label>
                        <lightning-formatted-text value={selected.phone}></lightning-formatted-text>
                    </div>
                    <div class="info-field">
                        <label>Email</label>
                        <lightning-formatted-text value={selected.email}></lightning-formatted-text>
                    </div>
                </div>

                <!-- Основна інформація постачальника -->
                <div class="main-edit-grid">
                    <lightning-input
                            label="Назва постачальника"
                            data-name="name"
                            value={editedMain.name}
                            onchange={handleMainInputChange}>
                    </lightning-input>

                    <lightning-input type="tel" label="Телефон" data-name="phone" value={editedMain.phone} onchange={handleMainInputChange}></lightning-input>

                    <lightning-input
                            type="email"
                            label="Email"
                            data-name="email"
                            value={editedMain.email}
                            onchange={handleMainInputChange}>
                    </lightning-input>

                    <lightning-input
                            label="Місто (BillingCity)"
                            data-name="billingCity"
                            value={editedMain.billingCity}
                            onchange={handleMainInputChange}>
                    </lightning-input>

                    <!-- Адреса (Billing) -->
                    <lightning-textarea
                            class="span-2"
                            label="Вулиця (BillingStreet)"
                            data-name="billingStreet"
                            value={editedMain.billingStreet}
                            onchange={handleMainInputChange}>
                    </lightning-textarea>

                    <lightning-textarea
                            class="span-2"
                            label="Примітки"
                            data-name="description"
                            value={editedMain.description}
                            onchange={handleMainInputChange}>
                    </lightning-textarea>
                </div>

                <div class="section-list">
                    <h3>Договори</h3>
                    <div class="table-wrapper">
                        <table class="drivers-table">
                            <thead>
                            <tr>
                                <th>Договір</th>
                                <th>Початок</th>
                                <th>Завершення</th>
                                <th>Активність</th>
                                <th>Буде чинною</th>
                            </tr>
                            </thead>
                            <tbody>
                            <template for:each={selected.contracts} for:item="c">
                                <tr key={c.id}>
                                    <td class="left">{c.dogN}</td>
                                    <td>{c.dateFrom}</td>
                                    <td>{c.dateTo}</td>
                                    <td><span class={c.activeClass}>{c.activeLabel}</span></td>
                                    <td>{c.willBeActive}</td>
                                </tr>
                            </template>
                            <template if:true={contractsEmpty}>
                                <tr><td colspan="5" class="sp-empty-row">Немає даних</td></tr>
                            </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Місця завантаження -->
                <div class="section-list">
                    <div class="head">
                        <h3>Місце завантаження</h3>
                        <!-- NEW: action-row у модалці -->
                        <div class="action-row">
                            <button class="secondary-button" onclick={addZoneInModal}>+ Додати адресу</button>
                        </div>
                    </div>


                    <div class="table-wrapper">
                        <table class="drivers-table">
                            <thead>
                            <tr>
                                <th>Назва</th>
                                <th>Країна</th>
                                <th>Місто</th>
                                <th>Адреса</th>
                                <th></th>
                            </tr>
                            </thead>
                            <tbody>
                            <template for:each={editZones} for:item="z">
                                <tr key={z.id} class={z.rowClass}>
                                    <!-- Назва -->
                                    <td class="left">
                                        <template if:true={z._isEditing}>
                                            <lightning-input data-type="zone" data-id={z.id} data-name="name"
                                                             value={z._draft.name} label="Назва"
                                                             onchange={handleRowDraftInput}></lightning-input>
                                        </template>
                                        <template if:false={z._isEditing}>
                                            {z.name}
                                        </template>
                                    </td>

                                    <!-- Країна (тільки перегляд) -->
                                    <td>{z.countryName}</td>

                                    <!-- Місто -->
                                    <td>
                                        <template if:true={z._isEditing}>
                                            <lightning-input data-type="zone" data-id={z.id} data-name="city"
                                                             value={z._draft.city} label="Місто"
                                                             onchange={handleRowDraftInput}></lightning-input>
                                        </template>
                                        <template if:false={z._isEditing}>
                                            {z.city}
                                        </template>
                                    </td>

                                    <!-- Адреса -->
                                    <td>
                                        <template if:true={z._isEditing}>
                                            <lightning-input data-type="zone" data-id={z.id} data-name="address"
                                                             value={z._draft.address} label="Адреса"
                                                             onchange={handleRowDraftInput}></lightning-input>
                                        </template>
                                        <template if:false={z._isEditing}>
                                            {z.address}
                                        </template>
                                    </td>

                                    <!-- Дії -->
                                    <td class="actions-cell">
                                        <template if:true={z._isEditing}>
                                            <button class="chip-save" data-type="zone" data-id={z.id} onclick={handleRowSave}>Зберегти</button>
                                            <button class="icon-button cancel" data-type="zone" data-id={z.id} onclick={cancelRowEdit}
                                                    title="Скасувати" aria-label="Скасувати">
                                                <!-- хрестик -->
                                                <svg viewBox="0 0 32 32" class="icon-20" xmlns="http://www.w3.org/2000/svg">
                                                    <path d="M16 29c-7.18 0-13-5.82-13-13s5.82-13 13-13 13 5.82 13 13-5.82 13-13 13zM16 6c-5.522 0-10 4.478-10 10s4.478 10 10 10c5.523 0 10-4.478 10-10s-4.477-10-10-10zM20.537 19.535l-1.014 1.014c-.186.186-.488.186-.675 0l-2.87-2.87-2.87 2.87c-.187.186-.488.186-.675 0l-1.014-1.014c-.186-.186-.186-.488 0-.675l2.871-2.869-2.871-2.87c-.186-.187-.186-.489 0-.676l1.014-1.013c.187-.187.488-.187.675 0l2.87 2.87 2.87-2.87c.187-.187.489-.187.675 0l1.014 1.013c.186.187.186.489 0 .676l-2.871 2.87 2.871 2.869c.186.187.186.49 0 .675z"></path>
                                                </svg>
                                            </button>
                                        </template>

                                        <template if:false={z._isEditing}>
                                            <button class="icon-button edit" data-type="zone" data-id={z.id} onclick={startRowEdit}
                                                    title="Редагувати" aria-label="Редагувати">
                                                <svg viewBox="0 0 24 24" class="icon-24" xmlns="http://www.w3.org/2000/svg">
                                                    <path d="M21.28 6.4L11.74 15.94c-.95.95-3.77 1.39-4.4.76-.63-.63-.2-3.45.75-4.4L17.64 2.75a3.2 3.2 0 014.57 4.57z" fill="none" stroke="#000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
                                                    <path d="M11 4H6a4 4 0 00-4 4v10a4 4 0 004 4h11c2.21 0 3-1.8 3-4v-5" fill="none" stroke="#000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
                                                </svg>
                                            </button>

                                            <template if:true={z.showDeleteIcon}>
                                                <button class="icon-button" data-type="zone" data-id={z.id} onclick={toggleMarkRemove}
                                                        title="Позначити на видалення" aria-label="Позначити на видалення">
                                                    <svg viewBox="0 0 24 24" class="icon-20" xmlns="http://www.w3.org/2000/svg">
                                                        <path d="M10 12V17M14 12V17M4 7H20M6 10V18c0 1.66 1.34 3 3 3h6c1.66 0 3-1.34 3-3V10M9 5c0-1.1.9-2 2-2h2a2 2 0 012 2v2H9V5z"
                                                              fill="none" stroke="#000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                                                    </svg>
                                                </button>
                                            </template>

                                            <template if:true={z.showReturnIcon}>
                                                <button class="icon-button" data-type="zone" data-id={z.id} onclick={toggleMarkRemove}
                                                        title="Повернути" aria-label="Повернути">
                                                    <svg viewBox="0 0 32 32" class="icon-20" xmlns="http://www.w3.org/2000/svg">
                                                        <path d="M0 21.984q.032-.8.608-1.376l4-4a2 2 0 012.496-.448c.64.32.896.8.896 1.376v1.984h18.016a2 2 0 002-1.984v-8a2 2 0 00-2-2.016h-16a2 2 0 01-1.888-2.56A2 2 0 018.128 4h16a6 6 0 016 6v8a6 6 0 01-6 6H8.112v2.016a2 2 0 01-3.392 1.408l-4-4A2 2 0 010 21.984z" fill="#000"></path>
                                                    </svg>
                                                </button>
                                            </template>
                                        </template>
                                    </td>
                                </tr>

                            </template>

                            <template if:true={editZonesEmpty}>
                                <tr><td colspan="5" class="sp-empty-row">Немає даних</td></tr>
                            </template>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="section-list">
                    <div class="head">
                        <h3>Водії</h3>
                        <div class="action-row">
                            <button class="secondary-button" onclick={addDriverInModal}>+ Додати водія</button>
                        </div>
                    </div>

                    <div class="table-wrapper">
                        <table class="drivers-table">
                            <thead>
                            <tr>
                                <th>ПІБ</th>
                                <th>Посада</th>
                                <th>Відділ</th>
                                <th>Телефон</th>
                                <th>Email</th>
                                <th></th>
                            </tr>
                            </thead>
                            <tbody>
                            <template for:each={editDrivers}  for:item="d">
                                <tr key={d.id} class={d.rowClass}>
                                    <!-- ПІБ (тільки перегляд) -->
                                    <td class="left">
                                        <template if:true={d._isNew}>
                                            <template if:true={d._isEditing}>
                                                <div class="name-grid">
                                                    <lightning-input label="Прізвище" required  data-type="driver"  data-id={d.id} data-name="lastName" value={d._person.lastName}  onchange={handlePersonNameDraft}></lightning-input>
                                                    <lightning-input label="Ім’я"  required    data-type="driver"  data-id={d.id} data-name="firstName" value={d._person.firstName} onchange={handlePersonNameDraft}></lightning-input>
                                                    <lightning-input label="По батькові" data-type="driver" data-id={d.id} data-name="middleName" value={d._person.middleName} onchange={handlePersonNameDraft}></lightning-input>
                                                </div>
                                            </template>
                                            <template if:false={d._isEditing}>
                                                {d.name}
                                            </template>
                                        </template>
                                        <!-- У колонці ПІБ для driver ЗАМІНИТИ блок для !d._isNew -->
                                        <template if:false={d._isNew}>
                                            <template if:true={d._isEditing}>
                                                <div class="name-grid">
                                                    <lightning-input label="Прізвище" required data-type="driver" data-id={d.id}
                                                                     data-name="lastName" value={d._draft.lastName}
                                                                     onchange={handleRowDraftInput}></lightning-input>
                                                    <lightning-input label="Ім’я" required data-type="driver" data-id={d.id}
                                                                     data-name="firstName" value={d._draft.firstName}
                                                                     onchange={handleRowDraftInput}></lightning-input>
                                                    <lightning-input label="По батькові" data-type="driver" data-id={d.id}
                                                                     data-name="middleName" value={d._draft.middleName}
                                                                     onchange={handleRowDraftInput}></lightning-input>
                                                </div>
                                            </template>
                                            <template if:false={d._isEditing}>
                                                {d.name}
                                            </template>
                                        </template>

                                    </td>


                                    <!-- Посада -->
                                    <td>
                                        <template if:false={d._isEditing}>
                                            {d.title}
                                        </template>
                                        <template if:true={d._isEditing}>
                                            <lightning-input
                                                    data-type="driver"
                                                    data-id={d.id}
                                                    label="Посада"
                                                    data-name="title"
                                                    value={d._draft.title}
                                                    onchange={handleRowDraftInput}>
                                            </lightning-input>
                                        </template>
                                    </td>

                                    <!-- Відділ -->
                                    <td>
                                        <template if:false={d._isEditing}>
                                            {d.dept}
                                        </template>
                                        <template if:true={d._isEditing}>
                                            <lightning-input
                                                    data-type="driver"
                                                    data-id={d.id}
                                                    data-name="dept"
                                                    label="Відділ"
                                                    value={d._draft.dept}
                                                    onchange={handleRowDraftInput}>
                                            </lightning-input>
                                        </template>
                                    </td>

                                    <!-- Телефон -->
                                    <td>
                                        <template if:false={d._isEditing}>
                                            {d.phone}
                                        </template>
                                        <template if:true={d._isEditing}>
                                            <lightning-input
                                                    data-type="driver"
                                                    data-id={d.id}
                                                    required
                                                    label="Телефон"
                                                    data-name="phone"
                                                    value={d._draft.phone}
                                                    onchange={handleRowDraftInput}>
                                            </lightning-input>
                                        </template>
                                    </td>

                                    <!-- Email -->
                                    <td>
                                        <template if:false={d._isEditing}>
                                            {d.email}
                                        </template>
                                        <template if:true={d._isEditing}>
                                            <lightning-input
                                                    type="email"
                                                    data-type="driver"
                                                    label="Email"
                                                    data-id={d.id}
                                                    data-name="email"
                                                    value={d._draft.email}
                                                    onchange={handleRowDraftInput}>
                                            </lightning-input>
                                        </template>
                                    </td>

                                    <!-- Дії -->
                                    <td class="actions-cell">
                                        <!-- Режим РЕДАГУВАННЯ: показуємо Зберегти + Хрестик -->
                                        <template if:true={d._isEditing}>
                                            <button class="chip-save"
                                                    data-type="driver"
                                                    data-id={d.id}
                                                    onclick={handleRowSave}>
                                                Зберегти
                                            </button>

                                            <button class="icon-button cancel"
                                                    data-type="driver"
                                                    data-id={d.id}
                                                    onclick={cancelRowEdit}
                                                    title="Скасувати"
                                                    aria-label="Скасувати">
                                                <!-- хрестик-іконка -->
                                                <svg viewBox="0 0 32 32" class="icon-20" xmlns="http://www.w3.org/2000/svg">
                                                    <path d="M16 29c-7.18 0-13-5.82-13-13s5.82-13 13-13 13 5.82 13 13-5.82 13-13 13zM16 6c-5.522 0-10 4.478-10 10s4.478 10 10 10c5.523 0 10-4.478 10-10s-4.477-10-10-10zM20.537 19.535l-1.014 1.014c-.186.186-.488.186-.675 0l-2.87-2.87-2.87 2.87c-.187.186-.488.186-.675 0l-1.014-1.014c-.186-.186-.186-.488 0-.675l2.871-2.869-2.871-2.87c-.186-.187-.186-.489 0-.676l1.014-1.013c.187-.187.488-.187.675 0l2.87 2.87 2.87-2.87c.187-.187.489-.187.675 0l1.014 1.013c.186.187.186.489 0 .676l-2.871 2.87 2.871 2.869c.186.187.186.49 0 .675z"></path>
                                                </svg>
                                            </button>
                                        </template>

                                        <!-- ЗВИЧАЙНИЙ режим: ✏️ редагувати + мусорка/повернути -->
                                        <template if:false={d._isEditing}>
                                            <button class="icon-button edit"
                                                    data-type="driver"
                                                    data-id={d.id}
                                                    onclick={startRowEdit}
                                                    title="Редагувати"
                                                    aria-label="Редагувати">
                                                <!-- ваш pencil SVG -->
                                                <svg viewBox="0 0 24 24" class="icon-24" xmlns="http://www.w3.org/2000/svg">
                                                    <path d="M21.28 6.4L11.74 15.94c-.95.95-3.77 1.39-4.4.76-.63-.63-.2-3.45.75-4.4L17.64 2.75a3.2 3.2 0 014.57 4.57z" fill="none" stroke="#000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                                    <path d="M11 4H6a4 4 0 00-4 4v10a4 4 0 004 4h11c2.21 0 3-1.8 3-4v-5" fill="none" stroke="#000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                                </svg>
                                            </button>

                                            <template if:true={d.showDeleteIcon}>
                                                <button class="icon-button"
                                                        data-type="driver"
                                                        data-id={d.id}
                                                        onclick={toggleMarkRemove}
                                                        title="Позначити на видалення"
                                                        aria-label="Позначити на видалення">
                                                    <!-- мусорка -->
                                                    <svg viewBox="0 0 24 24" class="icon-20" xmlns="http://www.w3.org/2000/svg">
                                                        <path d="M10 12V17M14 12V17M4 7H20M6 10V18c0 1.66 1.34 3 3 3h6c1.66 0 3-1.34 3-3V10M9 5c0-1.1.9-2 2-2h2a2 2 0 012 2v2H9V5z"
                                                              fill="none" stroke="#000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                                                    </svg>
                                                </button>
                                            </template>

                                            <template if:true={d.showReturnIcon}>
                                                <button class="icon-button"
                                                        data-type="driver"
                                                        data-id={d.id}
                                                        onclick={toggleMarkRemove}
                                                        title="Повернути"
                                                        aria-label="Повернути">
                                                    <!-- повернути -->
                                                    <svg viewBox="0 0 32 32" class="icon-20" xmlns="http://www.w3.org/2000/svg">
                                                        <path d="M0 21.984q.032-.8.608-1.376l4-4a2 2 0 012.496-.448c.64.32.896.8.896 1.376v1.984h18.016a2 2 0 002-1.984v-8a2 2 0 00-2-2.016h-16a2 2 0 01-1.888-2.56A2 2 0 018.128 4h16a6 6 0 016 6v8a6 6 0 01-6 6H8.112v2.016a2 2 0 01-3.392 1.408l-4-4A2 2 0 010 21.984z" fill="#000"/>
                                                    </svg>
                                                </button>
                                            </template>
                                        </template>
                                    </td>


                                </tr>
                            </template>

                            <template if:true={editDriversEmpty}>
                                <tr><td colspan="6" class="sp-empty-row">Немає даних</td></tr>
                            </template>

                            </tbody>

                        </table>
                    </div>
                    <!--                                <div class="hint">Позначені чер рядки будуть видалені після натискання «Зберегти».</div>-->
                </div>

                <!-- Менеджери -->
                <div class="section-list">
                    <div class="head">
                        <h3>Менеджери</h3>
                        <div class="action-row">
                            <button class="secondary-button" onclick={addManagerInModal}>+ Додати менеджера</button>
                        </div>
                    </div>

                    <div class="table-wrapper">
                        <table class="drivers-table">
                            <thead>
                            <tr>
                                <th>ПІБ</th>
                                <th>Посада</th>
                                <th>Відділ</th>
                                <th>Телефон</th>
                                <th>Email</th>
                                <th></th>
                            </tr>
                            </thead>
                            <tbody>
                            <template for:each={editManagers} for:item="m">
                                <tr key={m.id} class={m.rowClass}>
                                    <!-- ПІБ (тільки перегляд) -->

                                    <td class="left">
                                        <template if:true={m._isNew}>
                                            <template if:true={m._isEditing}>
                                                <div class="name-grid">
                                                    <lightning-input label="Прізвище" required data-type="manager" data-id={m.id} data-name="lastName" value={m._person.lastName}  onchange={handlePersonNameDraft}></lightning-input>
                                                    <lightning-input label="Ім’я"  required data-type="manager" data-id={m.id} data-name="firstName" value={m._person.firstName} onchange={handlePersonNameDraft}></lightning-input>
                                                    <lightning-input label="По батькові" data-type="manager" data-id={m.id} data-name="middleName" value={m._person.middleName} onchange={handlePersonNameDraft}></lightning-input>
                                                </div>
                                            </template>
                                            <template if:false={m._isEditing}>
                                                {m.name}
                                            </template>
                                        </template>
                                        <!-- У колонці ПІБ для manager ЗАМІНИТИ блок для !m._isNew -->
                                        <template if:false={m._isNew}>
                                            <template if:true={m._isEditing}>
                                                <div class="name-grid">
                                                    <lightning-input label="Прізвище" required data-type="manager" data-id={m.id}
                                                                     data-name="lastName" value={m._draft.lastName}
                                                                     onchange={handleRowDraftInput}></lightning-input>
                                                    <lightning-input label="Ім’я" required data-type="manager" data-id={m.id}
                                                                     data-name="firstName" value={m._draft.firstName}
                                                                     onchange={handleRowDraftInput}></lightning-input>
                                                    <lightning-input label="По батькові" data-type="manager" data-id={m.id}
                                                                     data-name="middleName" value={m._draft.middleName}
                                                                     onchange={handleRowDraftInput}></lightning-input>
                                                </div>
                                            </template>
                                            <template if:false={m._isEditing}>
                                                {m.name}
                                            </template>
                                        </template>

                                    </td>


                                    <!-- Посада -->
                                    <td>
                                        <template if:false={m._isEditing}>
                                            {m.title}
                                        </template>
                                        <template if:true={m._isEditing}>
                                            <lightning-input
                                                    data-type="manager"
                                                    label="Посада"
                                                    data-id={m.id}
                                                    data-name="title"
                                                    value={m._draft.title}
                                                    onchange={handleRowDraftInput}>
                                            </lightning-input>
                                        </template>
                                    </td>

                                    <!-- Відділ -->
                                    <td>
                                        <template if:false={m._isEditing}>
                                            {m.dept}
                                        </template>
                                        <template if:true={m._isEditing}>
                                            <lightning-input
                                                    data-type="manager"
                                                    data-id={m.id}
                                                    label="Відділ"
                                                    data-name="dept"
                                                    value={m._draft.dept}
                                                    onchange={handleRowDraftInput}>
                                            </lightning-input>
                                        </template>
                                    </td>

                                    <!-- Телефон -->
                                    <td>
                                        <template if:false={m._isEditing}>
                                            {m.phone}
                                        </template>
                                        <template if:true={m._isEditing}>
                                            <lightning-input
                                                    data-type="manager"
                                                    required
                                                    data-id={m.id}
                                                    label="Телефон"
                                                    data-name="phone"
                                                    value={m._draft.phone}
                                                    onchange={handleRowDraftInput}>
                                            </lightning-input>
                                        </template>
                                    </td>

                                    <!-- Email -->
                                    <td>
                                        <template if:false={m._isEditing}>
                                            {m.email}
                                        </template>
                                        <template if:true={m._isEditing}>
                                            <lightning-input
                                                    type="email"
                                                    data-type="manager"
                                                    label="Email"
                                                    data-id={m.id}
                                                    data-name="email"
                                                    value={m._draft.email}
                                                    onchange={handleRowDraftInput}>
                                            </lightning-input>
                                        </template>
                                    </td>

                                    <!-- Дії -->
                                    <td class="actions-cell">
                                        <!-- Редагування: Зберегти + Хрестик -->
                                        <template if:true={m._isEditing}>
                                            <button class="chip-save"
                                                    data-type="manager"
                                                    data-id={m.id}
                                                    onclick={handleRowSave}>
                                                Зберегти
                                            </button>
                                            <button class="icon-button cancel"
                                                    data-type="manager"
                                                    data-id={m.id}
                                                    onclick={cancelRowEdit}
                                                    title="Скасувати"
                                                    aria-label="Скасувати">
                                                <!-- твій круглий хрестик -->
                                                <svg fill="#000000" viewBox="0 0 32 32" class="icon-20" xmlns="http://www.w3.org/2000/svg">
                                                    <path d="M16 29c-7.18 0-13-5.82-13-13s5.82-13 13-13 13 5.82 13 13-5.82 13-13 13zM16 6c-5.522 0-10 4.478-10 10s4.478 10 10 10c5.523 0 10-4.478 10-10s-4.477-10-10-10zM20.537 19.535l-1.014 1.014c-.186.186-.488.186-.675 0l-2.87-2.87-2.87 2.87c-.187.186-.488.186-.675 0l-1.014-1.014c-.186-.186-.186-.488 0-.675l2.871-2.869-2.871-2.87c-.186-.187-.186-.489 0-.676l1.014-1.013c.187-.187.488-.187.675 0l2.87 2.87 2.87-2.87c.187-.187.489-.187.675 0l1.014 1.013c.186.187.186.489 0 .676l-2.871 2.87 2.871 2.869c.186.187.186.49 0 .675z"></path>
                                                </svg>
                                            </button>
                                        </template>

                                        <!-- Звичайний режим: ✏️ + мусорка/повернути -->
                                        <template if:false={m._isEditing}>
                                            <button class="icon-button edit"
                                                    data-type="manager"
                                                    data-id={m.id}
                                                    onclick={startRowEdit}
                                                    title="Редагувати"
                                                    aria-label="Редагувати">
                                                <svg viewBox="0 0 24 24" class="icon-24" xmlns="http://www.w3.org/2000/svg">
                                                    <path d="M21.28 6.4L11.74 15.94c-.95.95-3.77 1.39-4.4.76-.63-.63-.2-3.45.75-4.4L17.64 2.75a3.2 3.2 0 014.57 4.57z" fill="none" stroke="#000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
                                                    <path d="M11 4H6a4 4 0 00-4 4v10a4 4 0 004 4h11c2.21 0 3-1.8 3-4v-5" fill="none" stroke="#000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
                                                </svg>
                                            </button>

                                            <template if:true={m.showDeleteIcon}>
                                                <button class="icon-button"
                                                        data-type="manager"
                                                        data-id={m.id}
                                                        onclick={toggleMarkRemove}
                                                        title="Позначити на видалення"
                                                        aria-label="Позначити на видалення">
                                                    <svg viewBox="0 0 24 24" class="icon-20" xmlns="http://www.w3.org/2000/svg">
                                                        <path d="M10 12V17M14 12V17M4 7H20M6 10V18c0 1.66 1.34 3 3 3h6c1.66 0 3-1.34 3-3V10M9 5c0-1.1.9-2 2-2h2a2 2 0 012 2v2H9V5z"
                                                              fill="none" stroke="#000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                                                    </svg>
                                                </button>
                                            </template>

                                            <template if:true={m.showReturnIcon}>
                                                <button class="icon-button"
                                                        data-type="manager"
                                                        data-id={m.id}
                                                        onclick={toggleMarkRemove}
                                                        title="Повернути"
                                                        aria-label="Повернути">
                                                    <svg viewBox="0 0 32 32" class="icon-20" xmlns="http://www.w3.org/2000/svg">
                                                        <path d="M0 21.984q.032-.8.608-1.376l4-4a2 2 0 012.496-.448c.64.32.896.8.896 1.376v1.984h18.016a2 2 0 002-1.984v-8a2 2 0 00-2-2.016h-16a2 2 0 01-1.888-2.56A2 2 0 018.128 4h16a6 6 0 016 6v8a6 6 0 01-6 6H8.112v2.016a2 2 0 01-3.392 1.408л-4-4A2 2 0 010 21.984z" fill="#000"></path>
                                                    </svg>
                                                </button>
                                            </template>
                                        </template>
                                    </td>
                                </tr>
                            </template>

                            <template if:true={editManagersEmpty}>
                                <tr><td colspan="6" class="sp-empty-row">Немає даних</td></tr>
                            </template>
                            </tbody>
                        </table>
                    </div>
                </div>


                <!-- Контракти (тільки перегляд) -->


                <!-- Машини — заглушка -->
                <!-- Машини (у модалці) -->
                <!-- Машини (у модалці) -->
                <div class="section-list">
                    <div class="head">
                        <h3>Машини</h3>
                        <div class="action-row">
                            <button class="secondary-button" onclick={addVehicleInModal}>+ Додати транспортний засіб</button>
                        </div>
                    </div>

                    <div class="table-wrapper">
                        <table class="drivers-table">
                            <thead>
                            <tr>
                                <th>Держ. номер</th>
                                <th>Марка / Модель</th>
                                <th>Тип транспорту</th>
                                <th>Тоннаж, т</th>
                                <th></th>
                            </tr>
                            </thead>
                            <tbody>
                            <template for:each={editVehicles} for:item="v">
                                <tr key={v.id} class={v.rowClass}>
                                    <!-- Держ. номер -->
                                    <td class="left">
                                        <template if:true={v._isEditing}>
                                            <lightning-input
                                                    data-type="vehicle" data-id={v.id} data-name="plateNumber"
                                                    label="Держ. номер *" value={v._draft.plateNumber} required
                                                    onchange={handleRowDraftInput}>
                                            </lightning-input>
                                        </template>
                                        <template if:false={v._isEditing}>
                                            {v.plateNumber}
                                        </template>
                                    </td>

                                    <!-- Марка/модель -->
                                    <td>
                                        <template if:true={v._isEditing}>
                                            <lightning-input
                                                    data-type="vehicle" data-id={v.id} data-name="model"
                                                    label="Марка/Модель" value={v._draft.model} required
                                                    onchange={handleRowDraftInput}>
                                            </lightning-input>
                                        </template>
                                        <template if:false={v._isEditing}>
                                            {v.model}
                                        </template>
                                    </td>

                                    <!-- Тип транспорту (пікліст) -->
                                    <td>
                                        <template if:true={v._isEditing}>
                                            <div class="combo-wrap">
                                                <lightning-combobox
                                                        data-type="vehicle" data-id={v.id} data-name="type"
                                                        label="Тип транспорту" value={v._draft.type} required
                                                        options={typeOptions}
                                                        onchange={handleRowDraftInput}>
                                                </lightning-combobox>
                                            </div>
                                        </template>
                                        <template if:false={v._isEditing}>
                                            {v.type}
                                        </template>
                                    </td>

                                    <!-- Тоннаж -->
                                    <td>
                                        <template if:true={v._isEditing}>
                                            <lightning-input
                                                    type="number" step="0.01"
                                                    data-type="vehicle" data-id={v.id} data-name="tonnage"
                                                    label="Тоннаж, т" value={v._draft.tonnage} required
                                                    onchange={handleRowDraftInput}>
                                            </lightning-input>
                                        </template>
                                        <template if:false={v._isEditing}>
                                            {v.tonnage}
                                        </template>
                                    </td>

                                    <!-- Дії -->
                                    <td class="actions-cell">
                                        <template if:true={v._isEditing}>
                                            <button class="chip-save" data-type="vehicle" data-id={v.id} onclick={handleRowSave}>Зберегти</button>
                                            <button class="icon-button cancel" data-type="vehicle" data-id={v.id} onclick={cancelRowEdit}
                                                    title="Скасувати" aria-label="Скасувати">
                                                <!-- хрестик -->
                                                <svg viewBox="0 0 32 32" class="icon-20" xmlns="http://www.w3.org/2000/svg">
                                                    <path d="M16 29c-7.18 0-13-5.82-13-13s5.82-13 13-13 13 5.82 13 13-5.82 13-13 13zM16 6c-5.522 0-10 4.478-10 10s4.478 10 10 10c5.523 0 10-4.478 10-10s-4.477-10-10-10zM20.537 19.535l-1.014 1.014c-.186.186-.488.186-.675 0l-2.87-2.87-2.87 2.87c-.187.186-.488.186-.675 0l-1.014-1.014c-.186-.186-.186-.488 0-.675l2.871-2.869-2.871-2.87c-.186-.187-.186-.489 0-.676l1.014-1.013c.187-.187.488-.187.675 0l2.87 2.87 2.87-2.87c.187-.187.489-.187.675 0l1.014 1.013c.186.187.186.489 0 .676l-2.871 2.87 2.871 2.869c.186.187.186.49 0 .675z"></path>
                                                </svg>
                                            </button>
                                        </template>

                                        <template if:false={v._isEditing}>
                                            <button class="icon-button edit" data-type="vehicle" data-id={v.id} onclick={startRowEdit}
                                                    title="Редагувати" aria-label="Редагувати">
                                                <svg viewBox="0 0 24 24" class="icon-24" xmlns="http://www.w3.org/2000/svg">
                                                    <path d="M21.28 6.4L11.74 15.94c-.95.95-3.77 1.39-4.4.76-.63-.63-.2-3.45.75-4.4L17.64 2.75a3.2 3.2 0 014.57 4.57z" fill="none" stroke="#000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                                    <path d="M11 4H6a4 4 0 00-4 4v10a4 4 0 004 4h11c2.21 0 3-1.8 3-4v-5" fill="none" stroke="#000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                                </svg>
                                            </button>

                                            <!-- Відв’язати (тільки для існуючих, не для _isNew) -->
                                            <template if:true={v.showDeleteIcon}>
                                                <button class="icon-button" data-type="vehicle" data-id={v.id} onclick={toggleMarkRemove} title="Позначити на видалення" aria-label="Позначити на видалення">
                                                    <svg viewBox="0 0 24 24" class="icon-20" xmlns="http://www.w3.org/2000/svg">
                                                        <path d="M10 12V17M14 12V17M4 7H20M6 10V18c0 1.66 1.34 3 3 3h6c1.66 0 3-1.34 3-3V10M9 5c0-1.1.9-2 2-2h2a2 2 0 012 2v2H9V5z"
                                                              fill="none" stroke="#000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                                                    </svg>
                                                </button>
                                            </template>
                                            <template if:true={v.showReturnIcon}>
                                                <button class="icon-button"
                                                        data-type="vehicle"
                                                        data-id={v.id}
                                                        onclick={toggleMarkRemove}
                                                        title="Повернути"
                                                        aria-label="Повернути">
                                                    <svg viewBox="0 0 32 32" class="icon-20" xmlns="http://www.w3.org/2000/svg">
                                                        <path d="M0 21.984q.032-.8.608-1.376l4-4a2 2 0 012.496-.448c.64.32.896.8.896 1.376v1.984h18.016a2 2 0 002-1.984v-8a2 2 0 00-2-2.016h-16a2 2 0 01-1.888-2.56A2 2 0 018.128 4h16a6 6 0 016 6v8a6 6 0 01-6 6H8.112v2.016a2 2 0 01-3.392 1.408л-4-4A2 2 0 010 21.984z" fill="#000"></path>
                                                    </svg>
                                                </button>
                                            </template>
                                        </template>
                                    </td>
                                </tr>
                            </template>

                            <template if:true={editVehiclesEmpty}>
                                <tr><td colspan="5" class="sp-empty-row">Немає даних</td></tr>
                            </template>
                            </tbody>
                        </table>
                    </div>
                </div>


            </div>

            <div class="modal-footer">
                <button class="secondary-button" onclick={closeEditModal} disabled={saving}>Скасувати</button>
                <button class="primary-button" onclick={saveEditModal} disabled={saving}>Зберегти</button>
            </div>

            <template if:true={saving}>
                <div class="saving-overlay" role="status" aria-live="polite">
                    <lightning-spinner size="large" variant="brand" alternative-text="Збереження…"></lightning-spinner>
                    <div class="saving-text">Збереження…</div>
                </div>
            </template>

        </div>
    </div>
</template>
</template>